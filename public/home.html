<!DOCTYPE html>
<html lang="en">

<head>
  <link href="modal.css" rel="stylesheet">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>CU Dining Hack It</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/one-page-wonder.min.css" rel="stylesheet">

  <meta charset="UTF-8">
  <title>Home Tab</title>
  <link rel="stylesheet" href="resetstyle.css">
  <link rel="stylesheet" href="home.css">
  <link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lilita+One" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAciF6tIYYTc7hbE1OXLZ7E3wCVsu0qRW8",
      authDomain: "cuhackit-cd650.firebaseapp.com",
      databaseURL: "https://cuhackit-cd650.firebaseio.com",
      projectId: "cuhackit-cd650",
      storageBucket: "cuhackit-cd650.appspot.com",
      messagingSenderId: "279286731064",
      appId: "1:279286731064:web:4fabe058254c87e17a71cd",
      measurementId: "G-Q1FBFFYXQR"
    };
    firebase.initializeApp(config);
  </script>
  <script type="text/javascript">
    foods = ["fries", "burgers", "hamburger", "pizza", "cheese", "pepperoni", "pasta", "brownies", "cupcakes"];
    var completeArray = [
      {
        ingredients: [],
        body: "",
      }
    ];
    var arraycount1 = 0;
    var arraycount2 = 0;
    var currentGroupColor;
    var userRef;
    var currentposts = {};
    initApp = function () {
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.
          userRef = user;
          var database = firebase.database();
          var displayName = user.displayName;
          this.userPic = document.getElementById('user-pic');
          var email = user.email;
          var emailVerified = user.emailVerified;
          var photoURL = user.photoURL;
          var uid = user.uid;
          var phoneNumber = user.phoneNumber;
          var providerData = user.providerData;
          this.userPic.src = photoURL;
          try {
            firebase.database().ref().child('users' + uid).set({
              username: displayName,
              email: email,
              profile_picture: photoURL,
              userId: uid
            });
          }
          catch (error) {
            firebase.database().ref().child('users' + uid).update({
              username: displayName,
              email: email,
              profile_picture: photoURL,
              userId: uid
            });
          }
          //console.log("Trying to add the data");
          user.getIdToken().then(function (accessToken) {
            document.getElementById('sign-in-status').textContent = 'Signed in';
            document.getElementById('sign-in').textContent = 'Sign out';
            document.getElementById('account-details').textContent = JSON.stringify({
              displayName: displayName,
              email: email,
              emailVerified: emailVerified,
              phoneNumber: phoneNumber,
              photoURL: photoURL,
              uid: uid,
              accessToken: accessToken,
              providerData: providerData
            }, null, '  ');
          });
        } else {
          // User is signed out.
          document.getElementById('sign-in-status').textContent = 'Signed out';
          document.getElementById('sign-in').textContent = 'Sign in';
          document.getElementById('account-details').textContent = 'null';
        }
      }, function (error) {
        console.log(error);
      });
    };
    window.addEventListener('load', function () {
      initApp();
      //completeArray=[" "][" "];
      loadFeed();
    });
    function writeNewPost(uid, uname, pic, heading, text, image) {
      console.log("running writenewpost");
      var modal = document.getElementById('myModal').style.display = "none";
      var newPostKey = firebase.database().ref().child('posts').push().key;
      try {
        console.log(image[0].name);
        var postData = {
          author: uname,
          uid: uid,
          body: text,
          title: heading,
          date: new Date(),
          picturesrc: pic,
          postId: newPostKey,
          imagename: image[0].name
        };
      }
      catch (error) {
        var postData = {
          author: uname,
          uid: uid,
          body: text,
          title: heading,
          date: new Date(),
          picturesrc: pic,
          postId: newPostKey,
          imagename: "null"
        };
      }
      try {
        var storageRef = firebase.storage().ref().child(newPostKey + "/" + image[0].name).put(image[0]).then(function (imageSnapshot) {
          console.log("name of the image: " + image[0].name);
          console.log("uploaded image successfully");
        });
      }
      catch (error) {
        console.log("There was an error when uploading the image " + error);
      }
      // Get a key for a new Post.
      // Write the new post's data simultaneously in the posts list and the user's post list.
      var updates = {};
      updates['/posts/' + newPostKey] = postData;
      updates['/user-posts/' + uid + '/' + newPostKey] = postData;
      firebase.database().ref().child('posts/' + newPostKey).update(postData);
      firebase.database().ref().child('user-posts/' + uid + '/' + newPostKey).update(postData);
      //checkForTags(text.split(" "), postData, newPostKey);
      var title = document.getElementById('titleText').value = "";
      var text = document.getElementById('bodyText').value = "";
      console.log("added post");
    }
    var addPostPresent = false;
    function loadFeed() {
      console.log("resent length: " + completeArray.length);
      console.log("first element: " + completeArray[0][0]);
      console.log("running loadFeed");
      //var postContainer = document.getElementById("postContainer");
      //var storage=firebase.storage().ref().child()
      var leadsRef = firebase.database().ref().child('posts');
      leadsRef.on('value', function (snapshot) {
        //removeFeedNodes();
        var postContainer = document.createElement('div');
        postContainer.id = "postContainer";
        snapshot.forEach(function (childSnapshot) {
          var deletingPost = false;
          var childData = childSnapshot.val();
          console.log("childdata userid call returns: " + childData["uid"]);
          var postDiv = document.createElement('div');
          postDiv.id = "postDiv";
          var userInfo = document.createElement("div");
          userInfo.id = "userInfo";
          postDiv.appendChild(userInfo);
          var postData = document.createElement("div");
          postData.id = "postData";
          var userPicture = document.createElement("img");
          userPicture.id = "user-feed-pic";
          userPicture.src = childData["picturesrc"];
          userInfo.appendChild(userPicture);
          var userLabel = document.createElement("a");
          userLabel.id = "userLabel";
          userLabel.innerHTML = childData["author"];
          userLabel.href = "profile.html/?uid=" + childData["uid"];
          userLabel.style.color = "black";
          try {
            userInfo.style.backgroundColor = childData["color"];
          }
          catch (error) {
          }
          userInfo.appendChild(userLabel);
          var imageElement = document.createElement("img");
          imageElement.id = "imageElement";
          try {
            imageElement.id = "imageElement";
            firebase.storage().ref().child(childData["postId"] + "/" + childData["imagename"]).getDownloadURL().then(function (url) {
              var test = url;
              imageElement.src = test;
              postDiv.style.gridArea = "span 2";
            });
            imageElement.style.margin = "auto";
            imageElement.style.display = "block";
          }
          catch (error) {
            //console.log("error when loading the image: " + error);
            imageElement.remove();
          }
          if (childData["imagename"] === "null") {
            console.log("the name is null");
            imageElement.style.display = "none";
          }
          var titleText = document.createElement("h1");
          titleText.id = "titleElement";
          titleText.innerHTML = childData["title"];
          postData.appendChild(titleText);
          var bodyText = document.createElement("p");
          bodyText.id = "bodyElement";
          bodyText.innerHTML = childData["body"];
          if (arraycount1 ==0) {
          }
          else {
            completeArray.push({ingredients:[],body:""});
          }
          completeArray[arraycount1].body = childData["body"];
          //arraycount2 += 1;
          //completeArray[arraycount1][arraycount2] = childData["body"];
          //CheckTags(arraycount1, arraycount2);
          //arraycount2 = 0;
          arraycount1 =arraycount1+ 1;
          console.log(arraycount1);
          var postedDate = document.createElement("p");
          postedDate.id = "datePosted";
          var month = parseDate(childData["date"]).getMonth() + 1;
          var day = parseDate(childData["date"]).getDate();
          var year = parseDate(childData["date"]).getFullYear();
          postedDate.innerHTML = month.toString() + "/" + day.toString() + "/" + year.toString();
          userInfo.appendChild(postedDate);
          var likeButton = document.createElement("button");
          likeButton.id = "likeButton";
          likeButton.innerHTML = ":)";
          var canLike = true;
          if (childData['uid'] === userRef.uid) {
            let deletePost = document.createElement("span");
            deletePost.id = 'deletePost';
            deletePost.textContent = "x";
            userInfo.appendChild(deletePost);
            deletePost.addEventListener('click', (e) => {
              e.stopPropagation();
              deletingPost = true;
              leadsRef.child(childData["postId"]).remove();
              firebase.database().ref().child("user-posts").child(userRef.uid).child(childData['postId']).remove();
              try {
                firebase.database().ref().child("groups").child(childData["group"]).child("posts").child(childData['postId']).remove();
              }
              catch (error) {
                console.log(error);
              }
            })
          }
          postData.appendChild(imageElement);
          postData.appendChild(bodyText);
          postData.appendChild(document.createElement("br"));
          postData.appendChild(document.createElement("br"));
          postDiv.appendChild(userInfo);
          postDiv.appendChild(postData);
          postContainer.prepend(postDiv);
          document.body.appendChild(postContainer);
        });
      });
      //arraycount1 = 0;
    }
    function parseDate(input) {
      var parts = input.match(/(\d+)/g);
      // new Date(year, month [, date [, hours[, minutes[, seconds[, ms]]]]])
      return new Date(parts[0], parts[1] - 1, parts[2]); // months are 0-based
    }
    /*function CheckTags(firstindex, secondindex){
      var searching=completeArray[firstindex][secondindex].split(" ");
      for(var i=0;i<searching.length)
    }*/
  </script>

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
    <div class="container">
      <img class="nav-bar brand" src="img/ham.png">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <header class="masthead text-center text-white">
    <div class="masthead-content">
      <div class="container">
        <h1 class="masthead-heading mb-0">Clemson Dining Hacks</h1>
        <h2 class="masthead-subheading mb-0">Will Rock Your Socks Off</h2>
        <a href="#" id="addPost" class="btn btn-primary btn-xl rounded-pill mt-5">Submit a Dining Hack</a>
      </div>
    </div>
    <div class="bg-circle-1 bg-circle"></div>
    <div class="bg-circle-2 bg-circle"></div>
    <div class="bg-circle-3 bg-circle"></div>
    <div class="bg-circle-4 bg-circle"></div>
  </header>

  <section>
    <div class="text-center">
      <div class="diningHall">
        <div class="main">
          <h2>Choose a Dining Hall<h2>
          <select name="">
            <option value="1">Fresh Food Company</option>
            <option value="2">Schilleter</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section>
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6">
          <div class="p-5">
            <img class="img-fluid rounded-circle" src="img/02.jpg" alt="">
          </div>
        </div>
        <div class="col-lg-6">
          <div class="p-5">
            <h2 class="display-4">We salute you!</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quod aliquid, mollitia odio veniam sit iste esse assumenda amet aperiam exercitationem, ea animi blanditiis recusandae! Ratione voluptatum molestiae adipisci, beatae obcaecati.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6 order-lg-2">
          <div class="p-5">
            <img class="img-fluid rounded-circle" src="img/03.jpg" alt="">
          </div>
        </div>
        <div class="col-lg-6 order-lg-1">
          <div class="p-5">
            <h2 class="display-4">Let there be rock!</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Quod aliquid, mollitia odio veniam sit iste esse assumenda amet aperiam exercitationem, ea animi blanditiis recusandae! Ratione voluptatum molestiae adipisci, beatae obcaecati.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-5 bg-black">
    <div class="container">
      <p class="m-0 text-center text-white small">Copyright &copy; Your Website 2019</p>
    </div>
    <!-- /.container -->
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2 id="headerTitle">Add Post</h2>
      </div>
      <div class="modal-body">
    
        <h3 id="bodyLabel"></h3>
        <input id="bodyText" type="text" name="" value="">

       
        </div>

        <button id="submitButton" type="button">Post It!</button>
      </div>
    </div>

    <script>
      // Get the modal
      var modal = document.getElementById('myModal');

      // Get the button that opens the modal
      var postButton = document.getElementById("addPost");

      var groupButton = document.getElementById("addGroup");

      // Get the <span> element that closes the modal
      var span = document.getElementsByClassName("close")[0];

      // When the user clicks the button, open the modal
      postButton.onclick = function () {
        modal.style.display = "block";
        //document.getElementById("tagsText").style.display = "none";
        //document.getElementById("tagsLabel").style.display = "none";
        //document.getElementById("fileLabel").style.display = "block";
        //document.getElementById("fileOpener").style.display = "block";
        //document.getElementById("colorChooser").style.display = "none";

        var modalHeader = document.getElementById("headerTitle");
        modalHeader.innerHTML = "Add Post";
        //var title = document.getElementById("titleLabel");
        //title.innerHTML = "Title"
        var body = document.getElementById("bodyLabel");
        body.innerHTML = "Body"
        //var fileLabel = document.getElementById("fileLabel");
        //fileLabel.innerHTML = "Image (optional)";
        var submit = document.getElementById('submitButton');
        submit.onclick = function () {
          console.log("Submitting post.");
          //console.log(document.getElementById("fileOpener").files);
          writeNewPost(userRef.uid, userRef.displayName, userRef.photoURL, null, document.getElementById("bodyText").value, null)
        }
      }



      // When the user clicks on <span> (x), close the modal
      span.onclick = function () {
        modal.style.display = "none";
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }


    </script>
</body>

</html>